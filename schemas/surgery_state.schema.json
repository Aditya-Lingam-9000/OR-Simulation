{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://or-symphony.dev/schemas/surgery_state.schema.json",
  "title": "OR-Symphony Surgery State",
  "description": "Canonical JSON output contract for OR-Symphony state updates. All rule engine and LLM outputs must conform to this schema.",
  "type": "object",
  "required": ["metadata", "machines", "details", "suggestions", "confidence", "source"],
  "additionalProperties": false,
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Contextual metadata for the state update.",
      "properties": {
        "timestamp": {
          "type": "string",
          "description": "ISO-8601 UTC timestamp of the state update."
        },
        "surgery": {
          "type": "string",
          "description": "Surgery type name.",
          "enum": ["PCNL", "Partial Hepatectomy", "Lobectomy", ""]
        },
        "phase": {
          "type": "string",
          "description": "Current surgical phase identifier (e.g., Phase1, Phase2)."
        },
        "processing_time_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Processing time in milliseconds."
        },
        "matched_keywords": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Keywords that triggered machine matches."
        },
        "temporal": {
          "type": "string",
          "enum": ["none", "immediately", "after", "when", "in_time", "before", "during"],
          "description": "Temporal qualifier extracted from transcript."
        },
        "reasoning": {
          "type": "string",
          "description": "LLM reasoning text (from MedGemma)."
        },
        "next_phase": {
          "type": "string",
          "description": "Predicted next surgical phase (from LLM)."
        },
        "transcript_context": {
          "type": "string",
          "description": "Recent transcript context from rolling buffer."
        },
        "buffer_entries": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of entries in the rolling buffer."
        },
        "buffer_duration_s": {
          "type": "number",
          "minimum": 0,
          "description": "Duration span of the rolling buffer in seconds."
        },
        "session_elapsed_s": {
          "type": "number",
          "minimum": 0,
          "description": "Total session elapsed time in seconds."
        }
      },
      "additionalProperties": true
    },
    "machines": {
      "type": "object",
      "description": "Machine state toggles. Keys are '0' (OFF/STANDBY) and '1' (ON).",
      "required": ["0", "1"],
      "properties": {
        "0": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^M[0-9]{2}$"
          },
          "description": "Machine IDs that are OFF or in STANDBY."
        },
        "1": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^M[0-9]{2}$"
          },
          "description": "Machine IDs that are ON."
        }
      },
      "additionalProperties": false
    },
    "details": {
      "type": "object",
      "description": "Detailed toggle information.",
      "properties": {
        "toggles": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["machine_id", "name", "action"],
            "properties": {
              "machine_id": {
                "type": "string",
                "pattern": "^M[0-9]{2}$",
                "description": "Machine identifier."
              },
              "name": {
                "type": "string",
                "description": "Human-readable machine name."
              },
              "action": {
                "type": "string",
                "enum": ["ON", "OFF", "STANDBY"],
                "description": "Action taken on the machine."
              },
              "trigger": {
                "type": "string",
                "description": "Trigger text or pattern that matched."
              },
              "confidence": {
                "type": "number",
                "minimum": 0.0,
                "maximum": 1.0,
                "description": "Match confidence score."
              },
              "match_type": {
                "type": "string",
                "enum": ["trigger", "alias", "name", "llm"],
                "description": "How the machine was matched."
              }
            },
            "additionalProperties": false
          },
          "description": "Individual toggle details."
        },
        "negations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Negation phrases detected."
        },
        "debounced": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Machine IDs that were debounced."
        }
      },
      "additionalProperties": true
    },
    "suggestions": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Suggestions from the LLM or rule engine."
    },
    "confidence": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Overall confidence score for the state update."
    },
    "source": {
      "type": "string",
      "enum": ["rule", "medgemma", "rule+medgemma"],
      "description": "Source of the state update."
    }
  }
}
